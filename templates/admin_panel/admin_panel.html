{% extends "admin_panel/navbar_admin.html" %}
{% load static %}

{% block title %}Panel AdministradorREDIMIR{% endblock %}

{# ➊ CSS extra específico de este panel #}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_panel.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<script src="{% static 'js/admin_panel.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block main %}
<div class="row">
  <div class="col-md-4">
    <div class="card text-white bg-primary">
      <div class="card-body">
        <h5 class="card-title">Cantidad total de este Mes</h5>
        <p class="card-text">{{ total_mes_kg|floatformat:1 }} Kg</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-white bg-success">
      <div class="card-body">
        <h5 class="card-title">Registros de este Mes</h5>
        <p class="card-text">{{ cantidad_registros_mes }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-white bg-warning">
      <div class="card-body">
        <h5 class="card-title">Desecho con mas cantidad este Mes</h5>
        <p class="card-text">{{ desecho_mas_cantidad }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Row con ambos gráficos -->
<div class="row mt-4">
  <!-- GRÁFICO DE BARRAS (Izquierda - 60%) -->
  <div class="col-lg-7">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">Totales por Tipo de Residuo</h5>
          <div class="d-flex" role="group">
            <button type="button" class="btn boton-principal btn-sm me-2" onclick="descargarGrafico()" title="Descargar gráfico como PNG">
              <i class="bi bi-download"></i>
            </button>
            <button type="button" class="btn boton-principal btn-sm" data-bs-toggle="modal" data-bs-target="#modalConfigGrafico">
              <i class="bi bi-gear-fill"></i>
            </button>
          </div>
        </div>
        
        <div class="chart-container" style="position: relative; height: 450px;">
          <canvas id="graficoBarras"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- GRÁFICO DE TORTA (Derecha - 40%) -->
  <div class="col-lg-5">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">Distribución Porcentual</h5>
          <button type="button" class="btn boton-principal btn-sm" onclick="descargarGraficoTorta()" title="Descargar gráfico como PNG">
            <i class="bi bi-download"></i>
          </button>
        </div>
        
        <div class="chart-container" style="position: relative; height: 450px;">
          <canvas id="graficoTorta"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-2 mb-5">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title mb-3">Último Registro</h5>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Operador</th>
                                <th>Cliente</th>
                                <th>Fecha de subida</th>
                                <th>Ver a detalle</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-ultimo-registro">
                            <tr>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <a href="{% url 'generar_certificado' %}" class="card h-100 text-decoration-none bg-dark text-white text-center">
            <div class="card-body d-flex align-items-center justify-content-center">
                <h1 class="display-5 fw-bold mb-0">Generar Certificado <i class="bi bi-file-earmark-text-fill"></i></h1>
            </div>
        </a>
    </div>
</div>
</div>

<!-- Modal de Configuración BARRAS-->
<div class="modal fade" id="modalConfigGrafico" tabindex="-1" aria-labelledby="modalConfigGraficoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalConfigGraficoLabel">
          <i class="bi bi-sliders"></i> Configuración del Gráfico
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="config-section mb-4">
          <h6 class="config-section-title">
            <i class="bi bi-calendar3"></i> Tiempo
          </h6>
          <div class="config-section-content">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Año</label>
                <input type="number" id="filtroAnioGrafico" class="form-control" placeholder="Año actual" min="2020" max="2100" maxlength="4">
              </div>
              <div class="col-md-6">
                <label class="form-label">Mes</label>
                <select id="filtroMesGrafico" class="form-select">
                  <option value="">Todo el año</option>
                  <option value="1">Enero</option>
                  <option value="2">Febrero</option>
                  <option value="3">Marzo</option>
                  <option value="4">Abril</option>
                  <option value="5">Mayo</option>
                  <option value="6">Junio</option>
                  <option value="7">Julio</option>
                  <option value="8">Agosto</option>
                  <option value="9">Septiembre</option>
                  <option value="10">Octubre</option>
                  <option value="11">Noviembre</option>
                  <option value="12">Diciembre</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="config-section mb-4">
          <h6 class="config-section-title">
            <i class="bi bi-building"></i> Cliente
          </h6>
          <div class="config-section-content">
            <div id="contenedorClienteGrafico">
              <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#modalClienteGrafico">
                <i class="bi bi-building"></i> Seleccionar Cliente Específico
              </button>
              <small class="text-muted d-block mt-2">Por defecto muestra todos los clientes</small>
            </div>
          </div>
        </div>

        <div class="config-section">
          <h6 class="config-section-title">
            <i class="bi bi-recycle"></i> Tipos de Residuo
          </h6>
          <div class="config-section-content">
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="checkTodos" onchange="toggleTodosCheckbox()" checked>
              <label class="form-check-label fw-bold" for="checkTodos">
                <i class="bi bi-check-all"></i> Seleccionar Todos
              </label>
            </div>
            <div class="row g-2">
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input checkbox-residuo" type="checkbox" value="plastico" id="checkPlastico" onchange="actualizarCheckTodos()" checked>
                  <label class="form-check-label" for="checkPlastico">
                    <span class="badge" style="background-color: rgba(54, 162, 235, 0.7);">●</span> Plástico
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input checkbox-residuo" type="checkbox" value="carton" id="checkCarton" onchange="actualizarCheckTodos()" checked>
                  <label class="form-check-label" for="checkCarton">
                    <span class="badge" style="background-color: rgba(255, 206, 86, 0.7);">●</span> Cartón
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input checkbox-residuo" type="checkbox" value="papel" id="checkPapel" onchange="actualizarCheckTodos()" checked>
                  <label class="form-check-label" for="checkPapel">
                    <span class="badge" style="background-color: rgba(201, 203, 207, 0.7);">●</span> Papel
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input checkbox-residuo" type="checkbox" value="film" id="checkFilm" onchange="actualizarCheckTodos()" checked>
                  <label class="form-check-label" for="checkFilm">
                    <span class="badge" style="background-color: rgba(153, 102, 255, 0.7);">●</span> Films
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input checkbox-residuo" type="checkbox" value="latas" id="checkLatas" onchange="actualizarCheckTodos()" checked>
                  <label class="form-check-label" for="checkLatas">
                    <span class="badge" style="background-color: rgba(255, 159, 64, 0.7);">●</span> Latas
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input checkbox-residuo" type="checkbox" value="palets" id="checkPalets" onchange="actualizarCheckTodos()" checked>
                  <label class="form-check-label" for="checkPalets">
                    <span class="badge" style="background-color: rgba(75, 192, 192, 0.7);">●</span> Palets
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input checkbox-residuo" type="checkbox" value="chatarra" id="checkChatarra" onchange="actualizarCheckTodos()" checked>
                  <label class="form-check-label" for="checkChatarra">
                    <span class="badge" style="background-color: rgba(128, 128, 128, 0.7);">●</span> Chatarra
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input checkbox-residuo" type="checkbox" value="vidrio" id="checkVidrio" onchange="actualizarCheckTodos()" checked>
                  <label class="form-check-label" for="checkVidrio">
                    <span class="badge" style="background-color: rgba(0, 255, 127, 0.7);">●</span> Vidrio
                  </label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input checkbox-residuo" type="checkbox" value="tetrapack" id="checkTetrapack" onchange="actualizarCheckTodos()" checked>
                  <label class="form-check-label" for="checkTetrapack">
                    <span class="badge" style="background-color: rgba(255, 99, 132, 0.7);">●</span> Tetrapack
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="limpiarFiltrosGrafico()">
          <i class="bi bi-x-circle"></i> Limpiar Filtros
        </button>
        <button type="button" class="btn btn-primary" onclick="aplicarConfiguracion()">
          <i class="bi bi-check-circle"></i> Aplicar
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Modal de Configuración BARRAS/Cliente-->
<div class="modal fade" id="modalClienteGrafico" tabindex="-1" aria-labelledby="modalClienteGraficoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-building"></i> Seleccionar Cliente
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          {% for cliente in clientes_info %}
          <div class="col-6 col-md-4">
            <div class="cliente-card-grafico" onclick="seleccionarClienteGrafico({{ cliente.id }}, '{{ cliente.nombre|escapejs }}')"> <!-- Ignorar Error de Escritura-->
              <div class="cliente-imagen-container">
                <img src="{{ cliente.imagen.url }}" alt="{{ cliente.nombre }}" class="cliente-imagen">
              </div>
              <div class="cliente-nombre">{{ cliente.nombre }}</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal de Detalle del Registro -->
<div class="modal fade" id="modalDetalleRegistro" tabindex="-1" aria-labelledby="modalDetalleLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDetalleLabel">
          <i class="bi bi-info-circle-fill"></i> Detalles del Registro
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalDetalleContenido" style="max-height: 70vh; overflow-y: auto;">
        <!-- El contenido se llenará dinámicamente con JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}